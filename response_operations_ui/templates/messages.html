{% extends "layouts/base.html" %}
{% block page_title %}Messages | Survey Data Collection{% endblock %}

{% block main %}
</br>

<div role="main" id="main" class="page__main">
  <h1 class="jupiter" name="page-messages-title">Messages</h1>
  <ul class="nav-tabs">
    <li class="nav-tabs__tab{% if request.url.endswith('/messages') or request.url.endswith('/messages/') %} nav-tabs__tab--active{% endif %}">
        <a id="inbox" href="/messages" class="nav-tabs__tab nav-tabs__tab--active tab-label">Inbox</a>
    </li>
    <li class="nav-tabs__tab{% if 'label=SENT' in request.url %} nav-tabs__tab--active{% endif %}">
        <a id="sent" href="/messages?label=SENT" class="navgation-tabs__tab tab-label">Sent</a>
    </li>
    <li class="nav-tabs__tab{% if 'label=DRAFT' in request.url %} nav-tabs__tab--active{% endif %}">
        <a id="drafts" href="/messages?label=DRAFT" class="nav-tabs__tab tab-label">Drafts</a>
    </li>
</ul>

  <div class="grid">
    <div class="grid__col col-30@l">
      <div class="messages-list">
        {% with messages = get_flashed_messages() %}
          {% if messages %}
          <div class="panel panel--success">
              <div class="panel__body" data-qa="success-body">
                {% for message in messages %}
                <p class="mars" id="flashed-message-{{ loop.index }}">{{ message }}</p>
                {% endfor %}
              </div>
          </div>
          {% endif %}
        {% endwith %}
        {% if response_error %}
        <div class="container page__container">
          <div class="grid">
            <div class="grid__col col-12@m">
              <div role="main" id="mains" class="page__main">
                <h1 class="saturn u-mt-l">Oops! Something went wrong</h1>
                <p>
                  There's an issue with the messaging service, please try again later.
                </p>
                <p>
                  Until then you can still use other parts of the system.
                </p>
              </div>
            </div>
          </div>
        </div>
        {% else %}
        {% if not messages %}
          <p>No new messages</p>
        {% else %}
        <table id="tbl-messages" class="table__dense" summary="messages in the system">
          <thead class="table--head">
            <tr class="table--row">
              <th scope="col" class="table--header--cell tbl-messages-RU-Ref">
                RU Ref
              </th>
              <th scope="col" class="table--header--cell tbl-messages-business">
                Business name
              </th>
              <th scope="col" class="table--header--cell tbl-messages-subject">
                Subject
              </th>
              <th scope="col" class="table--header--cell tbl-messages-from">
                From
              </th>
              <th scope="col" class="table--header--cell tbl-messages-to">
                To
              </th>
              <th scope="col" class="table--header--cell tbl-messages-received">
                Received
              </th>
            </tr>
          </thead>
              <tbody>
              {% for message in messages %}
               <tr class="table--row table--row__selectable">
                <td name="tbl-messages-RU_Ref" class="table--cell tbl-messages-RU_Ref">
                    {{ message.ru_ref }}
                </td>
                <td name="tbl-messages-business" class="table--cell tbl-messages-business">
                    {{ message.business_name }}
                </td>
                <td name="tbl-messages-subject" class="table--cell tbl-messages-subject">
                    <a href="{{ url_for('messages_bp.view_conversation', thread_id=message.thread_id) }}#latest-message" id="message-link-{{ loop.index }}">{{ message.subject }}</a>
                </td>
                <td name="tbl-messages-from" class="table--cell tbl-messages-from">
                    {{ message.from }}
                </td>
                <td name="tbl-messages-to" class="table--cell tbl-messages-to">
                    {{ message.to }}
                </td>
                <td name="tbl-messages-received" class="table--cell tbl-messages-received">
                   {{ message.sent_date }}
                </td>
               </tr>
              {% endfor %}
              {% endif %}
          </tbody>
        </table>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}
