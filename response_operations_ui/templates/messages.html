{% extends "layouts/base.html" %}
{% set page_title = "Messages" %}

{% block main %}

  {% with messages = get_flashed_messages() %}
          {% if messages %}
          <div class="panel panel--simple panel--success col-6@m u-mb-m">
              <div class="panel__body" data-qa="success-body">
                {% for message in messages %}
                <p class="u-fs-r" id="flashed-message-{{ loop.index }}">{{ message }}</p>
                {% endfor %}
              </div>
          </div>
          {% endif %}
        {% endwith %}

  {% if change_survey %}
    <h1 class="u-fs-l u-mb-xs" name="page-messages-title">{{ displayed_short_name }} Messages

      <span class="u-fs-r">(<a id="change-survey" href="{{ url_for('messages_bp.select_survey') }}">Change survey</a>)</span>

    </h1>

  {% else %}
    <h1 class="u-fs-xl" name="page-messages-title">Messages</h1>
  {% endif %}
  <div class="grid">
    <div class="grid__col col-12@m">
      <nav class="nav nav--horizontal nav--sub nav--dark u-mb-l u-mt-s" role="menu">
            <ul class="nav__list" aria-label="Section navigation menu">
                <li class="nav__item u-fs-s {% if my_conversations =='true' %}nav__item--current{% endif %}">
                    <a class="nav__link" href="{{ url_for('messages_bp.view_selected_survey', selected_survey=selected_survey, my_conversations='true') }}" aria-current="{% if my_conversations %}location{% endif %}" role="menuitem">My Messages</a>
                </li>
                <li class="nav__item u-fs-s {% if not is_closed and not my_conversations == 'true' and not new_respondent_conversations == 'true'%}nav__item--current{% endif %}">
                    <a class="nav__link" href="{{ url_for('messages_bp.view_selected_survey', selected_survey=selected_survey) }}" aria-current="{% if not is_closed and not my_conversations %}location{% endif %}" role="menuitem">Open</a>
                </li>
                <li class="nav__item u-fs-s {% if is_closed %}nav__item--current{% endif %}">
                    <a class="nav__link" href="{{ url_for('messages_bp.view_selected_survey', selected_survey=selected_survey, is_closed='true') }}" aria-current="{% if is_closed %}location{% endif %}" role="menuitem">Closed</a>
                </li>
                <li class="nav__item u-fs-s {% if new_respondent_conversations == 'true' %}nav__item--current{% endif %}">
                    <a class="nav__link" href="{{ url_for('messages_bp.view_selected_survey', selected_survey=selected_survey, new_respondent_conversations='true') }}" aria-current="{% if new_respondent_conversations %}location{% endif %}" role="menuitem">Initial</a>
                </li>
            </ul>
      </nav>
      <div class="messages-list">
        {% if response_error %}
        <div class="container page__container">
          <div class="grid">
            <div class="grid__col col-12@m">
              <div role="main" id="mains" class="page__main">
                <h1 class="u-fs-l u-mt-l">Oops! Something went wrong</h1>
                <p>
                  There's an issue with the messaging service, please try again later.
                </p>
                <p>
                  Until then you can still use other parts of the system.
                </p>
              </div>
            </div>
          </div>
        </div>
        {% else %}
        {% if not messages %}
          {% if is_closed %}
          <p>No closed conversations</p>
          {% elif my_conversations == 'true' %}
          <p>There are currently no messages</p>
          {% else %}
          <p>No new conversations</p>
          {% endif %}
        {% else %}
        <table id="tbl-messages" class="table message-list sortable" summary="messages in the system">
          <thead class="table__head">
            <tr class="table__row">
              <th scope="col" class="message-list__ru-ref sortable-column">
                RU Ref
              </th>
              <th scope="col" class="message-list__ru-name sortable-column">
                Business name
              </th>
              <th scope="col" class="message-list__subject sortable-column">
                Subject
              </th>
              <th scope="col" class="message-list__from sortable-column">
                From
              </th>
              <th scope="col" class="message-list__to sortable-column">
                To
              </th>
              <th scope="col" class="message-list__date-time sortable-column">
                Date and time
              </th>
            </tr>
          </thead>
              <tbody class="table__body">
              {% for message in messages %}
                {% if message.unread %}
                   <tr name="message-unread" class="table__row table__row__selectable message-list__item--unread" id="message-{{ loop.index }}">
                    <td name="tbl-messages-RU_Ref" class="message-list__ru-ref circle-icon" id="ru-ref-{{ loop.index }}">
                {% else %}
                   <tr name="message" class="table__row table__row__selectable" id="message-{{ loop.index }}">
                    <td name="tbl-messages-RU_Ref" class="message-list__ru-ref" id="ru-ref-{{ loop.index }}">
                {% endif %}
                    {{ message.ru_ref or 'Unavailable' }}
                </td>
                <td name="tbl-messages-business" class="message-list__ru-name" id="business-name-{{ loop.index }}">
                    {{ message.business_name or 'Unavailable' }}
                </td>
                <td name="tbl-messages-subject" class="message-list__subject">
                    <a href="{{ url_for('messages_bp.view_conversation', thread_id=message.thread_id, page=page, my_conversations=my_conversations) }}#latest-message" id="message-link-{{ loop.index }}">{{ message.subject }}</a>
                </td>
                <td name="tbl-messages-from" class="message-list__from" id="message-from-{{ loop.index }}">
                    {{ message.from or 'Unavailable' }}
                </td>
                <td name="tbl-messages-to" class="message-list__to" id="message-to-{{ loop.index }}">
                    {{ message.to or 'Unavailable' }}
                </td>
                <td name="tbl-messages-received" class="message-list__date-time" id="received-time-{{ loop.index }}">
                   {{ message.sent_date or 'Unavailable' }}
                </td>
               </tr>
              {% endfor %}
              {% endif %}
          </tbody>
        </table>

        {{ pagination.links }}

        {% endif %}
      </div>
    </div>
  </div>
{% endblock %}
