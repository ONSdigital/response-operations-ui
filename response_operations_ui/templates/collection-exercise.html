{% extends "layouts/base.html" %}
{% block page_title %}{{survey.surveyRef}} {{survey.shortName}} {{ce.exerciseRef}} | Surveys | Survey Data Collection{% endblock %}

{% block main %}

<div role="main" id="main" class="page__main">
    {% if success_panel %}
      <div class="panel panel--simple panel--success">
        <div id="{{ success_panel.id }}" class="panel__body">
          {{ success_panel.message }}
        </div>
      </div>
    {% endif %}
    {% if processing %}
      <div class="panel panel--simple panel--info">
        <div id="processing-info" class="panel__body">
          Processing collection exercise â€“ <a id="a-processing-refresh" href="">refresh to see progress</a>
        </div>
      </div>
    {% elif validation_failed %}
      <div class="panel panel--simple panel--error">
        <div id="validation-error" class="panel__body">
          Error processing collection exercise
          {% if missing_ci %}
          <div id="collection-instrument-error">
            <a href="#ciFile">Check collection instruments</a>
          </div>
          {% endif %}
        </div>
      </div>
    {% endif %}
    {% if sample %}
      {% if sample.state == 'INIT' %}
        <div class="panel panel--simple panel--info u-mb-l">
            <div class="panel__body">
            Loading sample&hellip; <span class="u-ml-xs"><a href="/surveys/{{survey.shortName}}/{{ce.exerciseRef}}?show_msg=true">Refresh to see progress</a></span>
            </div>
        </div>
      {% elif sample.state == 'ACTIVE' and show_msg == 'true' %}
        <div class="panel panel--simple panel--success u-mb-l">
          <div class="panel__body">
            Sample loaded successfully
          </div>
        </div>
      {% elif sample.state == 'FAILED' and show_msg == 'true' %}
        <div class="panel panel--simple panel--error u-mb-l">
          <div class="panel__body">
           Error loading sample <span class="u-ml-xs"><a href="#section-sample">See error details</a></span>
          </div>
        </div>
      {% endif %}
    {% endif %}
    <h1 class="jupiter" name="page-ce-title">{{survey.shortName}} {{ce.exerciseRef}}</h1>
    <dl class="ce-info" id="ce-attributes">
      <dt class="ce-status__title item-headlines-term ce-status">
        Status:
      </dt>
      <dd class="ce-status__data item-headlines-definition ce-status" id="ce_status">
        {{ ce.state }}
      </dd>
      {% if ce.state|upper == "LIVE" %}
      <dt class="ce-status__title item-headlines-term ce-status">
        Report:
      </dt>
      <dd class="ce-status__data item-headlines-definition ce-status" id="ce_status">
        <a class="download" href="{{ url_for('collection_exercise_bp.response_chasing', ce_id=ce.id, survey_id=survey.id) }}">Response chasing</a>
      </dd>
      {% endif %}
    </dl>

    <div>
    {% if show_set_live_button %}
      <form id="form-ready-for-live" action="" class="form" method="post" enctype="multipart/form-data">
        <button id="btn-ready-for-live" onclick="return confirm('There\'s no going back...')" name="ready-for-live" class="btn btn--primary" type="submit">Set as ready for live</button>
      </form>
    {% endif %}
    </div>

  <div class="grid">
    <div class="grid__col col-6@l">

      {% include 'partials/error-box.html' %}

      <section class="ce-section ce-events">
        <h2 class="venus u-pt-m">Dates</h2>
        <table class="table table__dense" summary="Dates for this collection exercise">
          <thead class="table--head u-vh">
            <tr class="table--row">
              <th scope="col" class="table--header--cell tbl-ce-label">
                Event
              </th>
              <th scope="col" class="table--header--cell tbl-ce-value">
                Date
              </th>
              <th scope="col" class="table--header--cell tbl-ce-status">
                Status
              </th>
            </tr>
          </thead>

          <tbody>
            <tr class="table--row tbl-ce-label">
              <td class="table--cell">
                MPS (Main print selection)
              </td>
              <td class="table--cell tbl-ce-value ce-event-date" name="mps-date">
                {% if events.mps %}
                {{events.mps.day}} <em>{{events.mps.date}}</em> {{events.mps.time}}
                {% endif %}
              </td>
            </tr>

            <tr class="table--row">
              <td class="table--cell tbl-ce-label">
                Go live
              </td>
              <td class="table--cell tbl-ce-value ce-event-date" name="go-live-date">
                {% if events.go_live %}
                {{events.go_live.day}} <em>{{events.go_live.date}}</em> {{events.go_live.time}}
                {% endif %}
              </td>
            </tr>

            <tr class="table--row">
              <td class="table--cell tbl-ce-label">
                Return by
              </td>
              <td class="table--cell tbl-ce-value ce-event-date" name="return-by-date">
                {% if events.return_by %}
                {{events.return_by.day}} <em>{{events.return_by.date}}</em> {{events.return_by.time}}
                {% endif %}
              </td>
            </tr>

            <tr class="table--row">
              <td class="table--cell tbl-ce-label">
                First reminder
              </td>
              <td class="table--cell tbl-ce-value ce-event-date" name="first-reminder-date">
                {% if events.reminder %}
                {{events.reminder.day}} <em>{{events.reminder.date}}</em> {{events.reminder.time}}
                {% endif %}
              </td>
            </tr>

            {% if events.reminder2 %}
            <tr class="table--row">
              <td class="table--cell tbl-ce-label">
                Second reminder
              </td>
              <td class="table--cell tbl-ce-value ce-event-date" name="second-reminder-date">
                {{events.reminder2.day}} <em>{{events.reminder2.date}}</em> {{events.reminder2.time}}
              </td>
            </tr>
            {% endif %}

            {% if events.reminder3 %}
            <tr class="table--row">
              <td class="table--cell tbl-ce-label">
                Third reminder
              </td>
              <td class="table--cell tbl-ce-value ce-event-date" name="third-reminder-date">
                {{events.reminder3.day}} <em>{{events.reminder3.date}}</em> {{events.reminder3.time}}
              </td>
            </tr>
            {% endif %}

            <tr class="table--row">
              <td class="table--cell tbl-ce-label">
                Exercise end
              </td>
              <td class="table--cell tbl-ce-value ce-event-date" name="exercise-end-date">
                {% if events.exercise_end %}
                {{events.exercise_end.day}} <em>{{events.exercise_end.date}}</em> {{events.exercise_end.time}}
                {% endif %}
              </td>
            </tr>
          </tbody>
        </table>
      </section>

      <section id="section-sample" class="ce-section">
        <h2 class="venus u-pt-m">Sample</h2>
        {% if sample %}
          {% if 'ACTIVE' == sample.state %}
              <table id="sample-table" class="table table__dense" summary="Loaded sample summary">
                <tbody>
                  <tr class="table--row">
                    <td class="table--cell tbl-ce-label">
                      Total businesses
                    </td>
                    <td class="table--cell tbl-ce-value" name="total-businesses">
                      {{sample.totalSampleUnits}}
                    </td>
                  </tr>

                  <tr class="table--row">
                    <td class="table--cell tbl-ce-">
                      Collection instruments
                    </td>
                    <td class="table--cell tbl-ce-" name="total-ci">
                      {{sample.expectedCollectionInstruments}}
                    </td>
                  </tr>
                </tbody>
              </table>
              <p>Sample loaded: {{sample.ingestDateTime}}</p>
          {% elif 'INIT' == sample.state %}
              <div class="u-mb-xl">
                  <div class="mars">
                      Loading&hellip; <span class="u-ml-xs"><a href="/surveys/{{survey.shortName}}/{{ce.exerciseRef}}?show_msg=true">Refresh to see progress</a></span>
                   </div>
              </div>
          {% elif 'FAILED' == sample.state %}
               <div class="u-mb-xl">
                   <div class="panel panel--simple panel--error u-mb-l">
                       <div class="panel__body">
                           {{ sample.notes }}
                       </div>
                   </div>
               </div>
          {% endif %}
        {% elif not locked %}
          <div class="u-mb-m">
            <form id="form-load-sample"
                  method="post"
                  action=""
                  class="form"
                  enctype="multipart/form-data">
              <p>
                Choose a sample file to check details before loading
              </p>
              <label class="upload-file u-vh" for="sampleFile">Choose file</label>
              <input type="file" class="" name="sampleFile" id="sampleFile" onchange="handleFiles(this.files, {{ ci_classifiers }})"
              accept=".csv">

              <div id="sample-preview" class="u-mb-s"></div>

              <button id="btn-check-sample-contents" class="btn btn--primary unready" type="button" disabled="">Check sample contents</button>
              <button id="btn-load-sample" name="load-sample" class="btn btn--primary hidden" type="submit">Load sample</button>
              <button id="btn-cancel-load-sample" class="btn btn--secondary hidden" type="button" onclick="cancelLoadSample()">Cancel</button>
            </form>
          </div>
        {% endif %}
      </section>

      <section class="ce-section {{'panel panel--simple panel--error' if missing_ci else ''}}">
        <h2 class="venus u-pt-m">Collection instruments</h2>

        {% if collection_instruments %}
        <div>
          <table id="collection-instruments-table" class="table table__dense" summary="Sample details for this collection exercise">
            <thead class="table--head u-vh">
              <tr class="table--row">
                <th scope="col" class="table--header--cell tbl-ce-value">
                  Collection instrument
                </th>
              </tr>
            </thead>

            <tbody>
            {% for collection_instrument in collection_instruments %}
              <tr class="table--row">
                <td class="table--cell tbl-ce-value">
                  {{collection_instrument.file_name}}
                </td>
                {% if not locked %}
                <td class="table--cell tbl-ce-status tbl-ce-action">
                  <form id="form-unselect-ci-{{loop.index}}" action="" method="post">
                    <a class="remove-icon" href=# id="unlink-ci-{{loop.index}}" onclick="this.parentNode.submit()"></a>
                    <input type="hidden" name="ce_id" value="{{ ce.id }}">
                    <input type="hidden" name="ci_id" value="{{ collection_instrument.id }}">
                    <input type="hidden" name="unselect-ci">
                  </form>
                </td>
                {% endif %}
              </tr>
            {% endfor %}
            </tbody>
          </table>
        </div>
        {% endif %}

        {% if not locked %}
        <div class="u-mb-m">

          {% if eq_ci_selectors %}
          <form id="form-select-ci" action="" class="form" method="post" enctype="multipart/form-data">
                <div class="u-mb-s">
                  eQ collection instruments available:
                </div>
            <div id="ciSelectErrorPanel" class="{{'panel panel--simple panel--error' if error.section == 'ciSelect' else ''}}">
              <div id="ciSelectErrorPanelBody" class="{{'panel__body' if error.section == 'ciSelect' else ''}}">
                <input type="hidden" name="ce_id" value="{{ ce.id }}">
                {% for ci in eq_ci_selectors %}
                <div class="field__item js-focusable-box">
                  <input class="input input--checkbox js-focusable" name="checkbox-answer" value="{{ci.id}}" id="{{ci.id}}" type="checkbox">
                  <label class="label label--inline venus " for="{{ci.id}}">{{survey.surveyRef}} {{ci.file_name}} eQ </label>
                </div>
                {% endfor %}
                <div>
                  <button id="btn-add-ci" name="select-ci" class="btn btn--primary unready" type="submit">Add</button>
                </div>
              </div>
            </div>

          </form>
          {% else %}
          <form id="form-load-ci" action="" class="form" method="post" enctype="multipart/form-data">
            <p>
              Add {{'another' if collection_instruments else 'a'}} collection instrument. Must be XLSX
            </p>
            <div id="ciFileErrorPanel" class="{{'panel panel--simple panel--error' if error.section == 'ciFile' else ''}}">
              <div id="ciFileErrorPanelBody" class="{{'panel__body' if error.section == 'ciFile' else ''}}">
                <p id="ciFileErrorText" class="hidden">
                  Incorrect file type. Please choose a file type XLSX
                </p>
                <label class="upload-file u-vh" for="ciFile">Choose CI file</label>
                <input type="file" class="u-mb-s" name="ciFile" id="ciFile" required accept=".xlsx" onchange="checkSelectedCI(this.files)" />
              </div>
            </div>
            <button id="btn-load-ci" name="load-ci" class="btn btn--primary unready">Add CI</button>
          </form>
          {% endif %}
        </div>
        {% endif %}
      </section>
    </div>

    <div class="grid__col col-1@l">
    </div>

    <div class="grid__col col-5@l">
      <div class="ce-section ce-details">
        <h2 class="venus u-pt-m">Reference information for this collection exercise</h2>
        <table class="table table__dense" summary="Collection exercise details">
          <tbody>
            <tr class="table--row">
              <td class="table--cell tbl-ce-">
                Period
              </td>
              <td class="table--cell tbl-ce-" name="period">
                {{ce.exerciseRef}}
              </td>
              <td class="table--cell tbl-ce-">
                <form action="{{ url_for('collection_exercise_bp.view_collection_exercise_details', short_name=survey.shortName, period=ce.exerciseRef, surveyRef=survey.surveyRef)}}" method="get">
                {% if show_edit_period %}
                  <a class="edit-icon" href=# id="edit-collection-exercise-period" onclick="this.parentNode.submit()"></a>
                {% endif %}
                </form>
              </td>
            </tr>

            <tr class="table--row">
              <td class="table--cell tbl-ce-">
                Shown to respondent as
              </td>
              <td class="table--cell tbl-ce-" name="user-description">
                {{ce.userDescription}}
              </td>
              <td class="table--cell tbl-ce-">
                <form action="{{ url_for('collection_exercise_bp.view_collection_exercise_details', short_name=survey.shortName, period=ce.exerciseRef, surveyRef=survey.surveyRef)}}" method="get">
                  <a class="edit-icon" href=# id="edit-collection-exercise-user-description" onclick="this.parentNode.submit()"></a>
                </form>
              </td>
            </tr>

            <tr class="table--row">
              <td class="table--cell tbl-ce-label">
                Survey ID and Abbreviation
              </td>
              <td class="table--cell tbl-ce-value" name="survey-info">
                {{survey.surveyRef}} {{survey.shortName}}
              </td>
              <td class="table--cell tbl-ce-">
              </td>
            </tr>

            <tr class="table--row">
              <td class="table--cell tbl-ce-">
                Survey title
              </td>
              <td class="table--cell tbl-ce-" name="survey-title">
                {{survey.longName}}
              </td>
              <td class="table--cell tbl-ce-">
              </td>
            </tr>

            {% if events.ref_period_start %}
            <tr class="table--row">
              <td class="table--cell tbl-ce-label">
                Reference period start date
              </td>
              <td class="table--cell tbl-ce-" name="period-start-date">
                  {{events.ref_period_start.day}} {{events.ref_period_start.date}}
              </td>
              <td class="table--cell tbl-ce-">
              </td>
            </tr>
            {% endif %}

            {% if events.employment %}
            <tr class="table--row">
              <td class="table--cell tbl-ce-label">
                Employment date
              </td>
              <td class="table--cell tbl-ce-" name="employment-date">
                  {{events.employment.day}} {{events.employment.date}}
              </td>
              <td class="table--cell tbl-ce-">
              </td>
            </tr>
            {% endif %}

            {% if events.ref_period_end %}
            <tr class="table--row">
              <td class="table--cell tbl-ce-label">
                Reference period end date
              </td>
              <td class="table--cell tbl-ce-" name="period-end-date">
                  {{events.ref_period_end.day}} {{events.ref_period_end.date}}
              </td>
              <td class="table--cell tbl-ce-">
              </td>
            {% endif %}
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
{% endblock %}
