<section class="ons-u-mt-s">
    {% set surveyEditPermission = hasPermission('surveys.edit') %}
    {% set tblHeaders =  
          [ 
              { 
                  "value": "Sample",
                  "thClasses": "ons-u-fs-r--b"
              },
          ]
    %}
    {% set surveyTableData = {
        "variants": ['compact', 'responsive'],
        "id": "sample-table",
        "caption": 'Sample summary',
        "hideCaption": true,
        "ths": tblHeaders,
    } %}
    {% if sample %}
        {% if sample.state == 'ACTIVE' or sample.state == 'COMPLETE' %}
            {% do tblHeaders.append(
                {
                    "value": "Sample loaded: " + '<em>' + sample.ingestDateTime[:-7] + '</em>' + sample.ingestDateTime[-7:],
                    "thClasses": "ons-u-fs-r",
                    "numeric": "true"
                }
             )%}
            {% set surveyTableDataRows = [
                {
                    "tds": [
                        {
                            "value": "Total businesses"
                        },
                        {
                            "value": sample.totalSampleUnits,
                            "name": "total-businesses",
                            "numeric": "true"
                        }
                    ]
                },
                {
                    "tds": [
                        {
                            "value": "Collection instruments needed"
                        },
                        {
                            "value": sample.expectedCollectionInstruments,
                            "name": "total-ci",
                            "numeric": "true"
                        }
                    ]
                }
            ] %}
            
            {% do surveyTableData | setAttribute("trs", surveyTableDataRows) %}
        {% endif %}
            {{
                onsTable(surveyTableData)
            }}
        {% if 'INIT' == sample.state %}
            <div class="ons-u-mb-m">
                <div class="ons-u-fs-r">
                    Loadingâ€¦ <span class="ons-u-ml-xs"><a href="/surveys/{{survey.shortName}}/{{ce.exerciseRef}}/view-sample-ci?show_msg=true">Refresh to see progress</a></span>
                </div>
            </div>
        {% elif 'FAILED' == sample.state %}
            {% call
                onsPanel({
                    "type": "error",
                    "classes": "ons-u-mb-l"
                })
            %}
                {{ sample.notes }}
            {% endcall %}
        {% endif %}
    {% else %}
        {% set surveyTableDataRows = [
            {
                "tds": [
                    {
                        "value": "No sample file uploaded"
                    }
                ]
            },
        ] %}
        {% do surveyTableData | setAttribute("trs", surveyTableDataRows) %}
    
        {{
            onsTable(surveyTableData)
        }}
    {% endif %}

    {% if not sample %}
          {% set sampleButtonText = 'Upload sample file' %}
          {% set sampleButtonLink = url_for('collection_exercise_bp.get_upload_sample_file', short_name=survey.shortName, period=ce.exerciseRef) %}
    {% else %}
          {% set sampleButtonText = 'Replace sample file' %}
          {% set sampleButtonLink = url_for('collection_exercise_bp.get_confirm_remove_sample', short_name=survey.shortName, period=ce.exerciseRef) %}
    {% endif %}
    {% if (not locked) and surveyEditPermission %}
        {{
            onsButton({
                "text": sampleButtonText,
                "id": 'btn-upload-sample-file',
                "submitType": 'timer',
                "variants": ['secondary', 'small'],
                "url": sampleButtonLink,
                "noIcon": 'true'
            })
        }}
  {% endif %}
</section>
