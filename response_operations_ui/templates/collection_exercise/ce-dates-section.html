<section class="ce-section ce-events">
  <h2 class="u-fs-r--b u-pt-m">Dates</h2>
  
  {% set dateGroups = ['mps', 'go_live', 'return_by', 'reminder', 'reminder2', 'reminder3'] %}

  {% set surveyTableData = {
      "table_class": 'table--dense',
      "caption": 'Dates for this collection exercise',
      "hideCaption": true,
      "ths": [
        { 
            "value": "Event",
            "class": "u-vh"
        },
        { 
            "value": "Date",
            "class": "u-vh"
        },
        { 
            "value": "Status",
            "class": "u-vh"
        }
      ]
    }
  %}

  {% set surveyTableDataRows = [] %}

  {% for dateGroup in dateGroups %}
    {% if dateGroup == 'mps' %}
      {% set label = 'MPS (Main print selection)' %}
      {% set event = events.mps %}
      {% if event %}
        {% set eventDay = events.mps.day %}
        {% set eventDate = events.mps.date %}
        {% set eventTime = events.mps.time %}
      {% endif %}
    {% elif dateGroup == 'go_live' %}
      {% set label = 'Go live' %}
      {% set event = events.go_live %}
      {% if event %}
        {% set eventDay = events.go_live.day %}
        {% set eventDate = events.go_live.date %}
        {% set eventTime = events.go_live.time %}
      {% endif %}
    {% elif dateGroup == 'return_by' %}
      {% set label = 'Return by' %}
      {% set event = events.return_by %}
      {% if event %}
        {% set eventDay = events.return_by.day %}
        {% set eventDate = events.return_by.date %}
        {% set eventTime = events.return_by.time %}
      {% endif %}
    {% elif dateGroup == 'reminder' %}
      {% set label = 'First reminder' %}
      {% set event = events.reminder %}
      {% if event %}
        {% set eventDay = events.reminder.day %}
        {% set eventDate = events.reminder.date %}
        {% set eventTime = events.reminder.time %}
        {% set eventIsInFuture = events.reminder.is_in_future %}
      {% endif %}
    {% elif dateGroup == 'reminder2' %}
      {% set event = events.reminder2 %}
      {% if events.reminder %}
        {% set showReminder = true %}
        {% set label = 'Second reminder' %}
      {% endif %}
      {% if event %}
        {% set eventDay = events.reminder2.day %}
        {% set eventDate = events.reminder2.date %}
        {% set eventTime = events.reminder2.time %}
        {% set eventIsInFuture = events.reminder2.is_in_future %}
      {% endif %}
    {% elif dateGroup == 'reminder3' %}
      {% set event = events.reminder3 %}
      {% if events.reminder2 %}
        {% set showReminder = true %}
        {% set label = 'Third reminder' %}
      {% endif %}
      {% if event %}
        {% set eventDay = events.reminder3.day %}
        {% set eventDate = events.reminder3.date %}
        {% set eventTime = events.reminder3.time %}
        {% set eventIsInFuture = events.reminder3.is_in_future %}
      {% endif %}
    {% endif %}

    {% if not event %}
      {% set formData = {
        "action": url_for('collection_exercise_bp.get_create_collection_event_form', short_name=survey.shortName, period=ce.exerciseRef, ce_id=ce.id, tag=dateGroup),
        "method": 'get',
        "button": {
          "text": 'Add',
          "id": 'create-event-date' + dateGroup,
          "classes": 'btn--secondary btn--small'
        }
      } %}

    {% elif not locked or (eventIsInFuture if eventIsInFuture) %}
      {% set formData = {
        "action": url_for('collection_exercise_bp.update_event_date', short_name=survey.shortName, period=ce.exerciseRef, tag=dateGroup),
        "method": 'get',
        "button": {
          "text": 'Edit',
          "id": 'edit-event-date' + dateGroup,
          "classes": 'btn--secondary btn--small'
        }
      } %}
    {% endif %}
    {% if event or showReminder %}
      {% do surveyTableDataRows.append(
        {
          "tds": [
            {
              "value": label
            },
            {
              "value": eventDay + ' <em>' + eventDate + '</em> ' + eventTime if event
            },
            {
              "form": formData 
            }
          ]
        }
      ) %}
    {% endif %}
  {% endfor %}

  {% do surveyTableData | setAttribute("trs", surveyTableDataRows) %}

  {{
    onsTable(surveyTableData)
  }}

  <table class="table table--dense" summary="Dates for this collection exercise">
    <thead class="table__head u-vh">
    <tr class="table__row">
      <th scope="col" class="table__header tbl-ce-label">
        Event
      </th>
      <th scope="col" class="table__header tbl-ce-value">
        Date
      </th>
      <th scope="col" class="table__header tbl-ce-status">
        Status
      </th>
    </tr>
    </thead>
    <tbody class="table__body">
    <tr class="table__row">
      <td class="table__cell tbl-ce-label">
        MPS (Main print selection)
      </td>

      <td class="table__cell tbl-ce-value ce-event-date" name="mps-date">
        {% if events.mps %}
        {{events.mps.day}} <em>{{events.mps.date}}</em> {{events.mps.time}}
        {% endif %}
      </td>

      <td class="table__cell tbl-ce-status tbl-ce-action">
        {% if not events.mps %}
        <form action="{{ url_for('collection_exercise_bp.get_create_collection_event_form', short_name=survey.shortName, period=ce.exerciseRef, ce_id=ce.id, tag='mps')}}" method="get">
          {{
            onsButton({
                "text": "Add",
                "id": "create-event-date-mps",
                "classes": "btn--secondary btn--small"
            })
          }}   
        </form>
        {% elif not locked %}
        <form action="{{ url_for('collection_exercise_bp.update_event_date', short_name=survey.shortName, period=ce.exerciseRef, tag='mps')}}" method="get">
          <a class="edit-icon" href=# id="edit-event-date-mps" onclick="this.parentNode.submit()"></a>
        </form>
        {% endif %}
      </td>
    </tr>

    <tr class="table__row">
      <td class="table__cell tbl-ce-label">
        Go live
      </td>

      <td class="table__cell tbl-ce-value ce-event-date" name="go-live-date">
        {% if events.go_live %}
        {{events.go_live.day}} <em>{{events.go_live.date}}</em> {{events.go_live.time}}
        {% endif %}
      </td>

      <td class="table__cell tbl-ce-status tbl-ce-action">
        {% if not events.go_live %}
        <form action="{{ url_for('collection_exercise_bp.get_create_collection_event_form', short_name=survey.shortName, period=ce.exerciseRef, ce_id=ce.id, tag='go_live')}}" method="get">
          {{
            onsButton({
                "text": "Add",
                "id": "create-event-date-go-live",
                "classes": "btn--secondary btn--small"
            })
          }}   
        </form>
        {% elif not locked %}
        <form action="{{ url_for('collection_exercise_bp.update_event_date', short_name=survey.shortName, period=ce.exerciseRef, tag='go_live')}}" method="get">
          <a class="edit-icon" href=# id="edit-event-date-go-live" onclick="this.parentNode.submit()"></a>
        </form>
        {% endif %}
      </td>
    </tr>

    <tr class="table__row">
      <td class="table__cell tbl-ce-label">
        Return by
      </td>

      <td class="table__cell tbl-ce-value ce-event-date" name="return-by-date">
        {% if events.return_by %}
        {{events.return_by.day}} <em>{{events.return_by.date}}</em> {{events.return_by.time}}
        {% endif %}
      </td>

      <td class="table__cell tbl-ce-status tbl-ce-action">
        {% if not events.return_by %}
        <form action="{{ url_for('collection_exercise_bp.get_create_collection_event_form', short_name=survey.shortName, period=ce.exerciseRef, ce_id=ce.id, tag='return_by')}}" method="get">
          {{
            onsButton({
                "text": "Add",
                "id": "create-event-date-return-by",
                "classes": "btn--secondary btn--small"
            })
          }}   
        </form>
        {% elif not locked %}
        <form action="{{ url_for('collection_exercise_bp.update_event_date', short_name=survey.shortName, period=ce.exerciseRef, tag='return_by')}}" method="get">
          <a class="edit-icon" href=# id="edit-event-date-return-by" onclick="this.parentNode.submit()"></a>
        </form>
        {% endif %}
      </td>
    </tr>

    <tr class="table__row">
      <td class="table__cell tbl-ce-label">
        First reminder
      </td>

      <td class="table__cell tbl-ce-value ce-event-date" name="first-reminder-date">
        {% if events.reminder %}
        {{events.reminder.day}} <em>{{events.reminder.date}}</em> {{events.reminder.time}}
        {% endif %}
      </td>

      <td class="table__cell tbl-ce-status tbl-ce-action">
        {% if not events.reminder %}
        <form action="{{ url_for('collection_exercise_bp.get_create_collection_event_form', short_name=survey.shortName, period=ce.exerciseRef, ce_id=ce.id, tag='reminder')}}" method="get">
          {{
            onsButton({
                "text": "Add",
                "id": "create-event-date-reminder",
                "classes": "btn--secondary btn--small"
            })
          }}   
        </form>
        {% elif events.reminder and (not locked or events.reminder.is_in_future) %}
        <form action="{{ url_for('collection_exercise_bp.update_event_date', short_name=survey.shortName, period=ce.exerciseRef, tag='reminder', errors=None)}}" method="get">
          <a class="edit-icon" href=# id="edit-event-date-reminder" onclick="this.parentNode.submit()"></a>
        </form>
        {% endif %}
      </td>
    </tr>

    {% if events.reminder %}
    <tr class="table__row">
      <td class="table__cell tbl-ce-label">
        Second reminder
      </td>

      <td class="table__cell tbl-ce-value ce-event-date" name="second-reminder-date">
        {% if events.reminder2 %}
        {{events.reminder2.day}} <em>{{events.reminder2.date}}</em> {{events.reminder2.time}}
        {% endif %}
      </td>

      <td class="table__cell tbl-ce-status tbl-ce-action">
        {% if not events.reminder2 %}
        <form action="{{ url_for('collection_exercise_bp.get_create_collection_event_form', short_name=survey.shortName, period=ce.exerciseRef, ce_id=ce.id, tag='reminder2')}}" method="get">
          {{
            onsButton({
                "text": "Add",
                "id": "create-event-date-reminder2",
                "classes": "btn--secondary btn--small"
            })
          }}   
        </form>
        {% elif events.reminder2 and (not locked or events.reminder2.is_in_future) %}
        <form action="{{ url_for('collection_exercise_bp.update_event_date', short_name=survey.shortName, period=ce.exerciseRef, tag='reminder2')}}" method="get">
          <a class="edit-icon" href=# id="edit-event-date-reminder2" onclick="this.parentNode.submit()"></a>
        </form>
        {% endif %}
      </td>
    </tr>
    {% endif %}

    {% if events.reminder2 %}
    <tr class="table__row">
      <td class="table__cell tbl-ce-label">
        Third reminder
      </td>

      <td class="table__cell tbl-ce-value ce-event-date" name="third-reminder-date">
        {% if events.reminder3 %}
        {{events.reminder3.day}} <em>{{events.reminder3.date}}</em> {{events.reminder3.time}}
        {% endif %}
      </td>

      <td class="table__cell tbl-ce-status tbl-ce-action">
        {% if not events.reminder3 %}
        <form action="{{ url_for('collection_exercise_bp.get_create_collection_event_form', short_name=survey.shortName, period=ce.exerciseRef, ce_id=ce.id, tag='reminder3')}}" method="get">
          {{
            onsButton({
                "text": "Add",
                "id": "create-event-date-reminder3",
                "classes": "btn--secondary btn--small"
            })
          }} 
        </form>
        {% elif events.reminder3 and (not locked or events.reminder3.is_in_future) %}
        <form action="{{ url_for('collection_exercise_bp.update_event_date', short_name=survey.shortName, period=ce.exerciseRef, tag='reminder3')}}" method="get">
          <a class="edit-icon" href=# id="edit-event-date-reminder3" onclick="this.parentNode.submit()"></a>
        </form>
        {% endif %}
      </td>
    </tr>
    {% endif %}

    <tr class="table__row">
      <td class="table__cell tbl-ce-label">
        Exercise end
      </td>

      <td class="table__cell tbl-ce-value ce-event-date" name="exercise-end-date">
        {% if events.exercise_end %}
        {{events.exercise_end.day}} <em>{{events.exercise_end.date}}</em> {{events.exercise_end.time}}
        {% endif %}
      </td>

      <td class="table__cell tbl-ce-status tbl-ce-action">
        {% if not events.exercise_end %}
        <form action="{{ url_for('collection_exercise_bp.get_create_collection_event_form', short_name=survey.shortName, ce_id=ce.id, period=ce.exerciseRef, tag='exercise_end')}}" method="get">
          {{
            onsButton({
                "text": "Add",
                "id": "create-event-date-exercise-end",
                "classes": "btn--secondary btn--small"
            })
          }} 
        </form>
        {% elif not locked %}
        <form action="{{ url_for('collection_exercise_bp.update_event_date', short_name=survey.shortName, period=ce.exerciseRef, tag='exercise_end')}}" method="get">
          <a class="edit-icon" href=# id="edit-event-date-exercise-end" onclick="this.parentNode.submit()"></a>
        </form>
        {% endif %}
      </td>
    </tr>
    </tbody>
  </table>
</section>
