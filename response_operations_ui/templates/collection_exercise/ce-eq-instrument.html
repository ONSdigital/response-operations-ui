<section class="ce-section {{'ons-panel ons-panel--simple ons-panel--error' if missing_ci else ''}} ons-u-pt-m ons-u-mb-l ons-u-mt-M">
    {% set surveyEditPermission = hasPermission('surveys.edit') %}
            {% if collection_instruments %}
                {% set surveyTableDataHeader = [] %}
                {% set ths = 
                    [ 
                        {
                            "value": "Collection instruments ",
                            "thClasses": "ons-u-fs-r--b"
                        },
                    ]
                %}  
                {% if surveyEditPermission %} 
                    {% do ths.append(
                        {
                            "value": " ",
                            "class": "ons-u-vh"
                        },
                    ) %} 
                {% endif %}
                {% set surveyTableData = {
                    "variants": ['compact', 'responsive'],
                    "id": "collection-instruments-table",
                    "caption": 'Collection instruments for this exercise',
                    "hideCaption": true,
                    "ths": ths
                } %}
                {% set surveyTableDataRows = [] %}
                {% for collection_instrument in collection_instruments["EQ"] %}
                    {% if not locked and surveyEditPermission%}
                        {% set formData =
                            '<form id="form-unselect-eq-ci-' + loop.index|string + '" action="" method="post">' +
                            '<a href=# id="unlink-eq-ci-' + loop.index|string + '"><svg class="ons-ons-svg-icon" viewBox="0 0 45 22" xmlns="http://www.w3.org/2000/svg" focusable="false"><path d="M0 0h24v24H0z" fill="none"/><path d="M7 11v2h10v-2H7zm5-9C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/></svg></a>' +
                            '<input type="hidden" name="ce_id" value="' + ce.id + '"/>' +
                            '<input type="hidden" name="ci_id" value="' + collection_instrument.id + '"/>' +
                            '<input type="hidden" name="unselect-eq-ci"/>' +
                            '<input type="hidden" name="csrf_token" value="' + csrf_token() + '" />' +
                            '</form>'
                        %}
                    {% endif %}
                    {% set tds = 
                        [ 
                            {
                                "value": collection_instrument.file_name
                            },
                        ]
                    %}  
                    {% if surveyEditPermission %} 
                        {% do tds.append(
                            {
                                "value": formData,
                                "tdClasses": "ons-u-vh-right"
                            },
                        ) %} 
                    {% endif %}   
                    {% do surveyTableDataRows.append( 
                        { 
                            "tds": tds 
                        } 
                    )%}
  
                {% endfor %}
                {% do surveyTableData | setAttribute("trs", surveyTableDataRows) %}
                {{ onsTable(surveyTableData) }}
                {% if not locked %}
                    {% for i in range(surveyTableDataRows | length) %}
                        {% set j = i + 1 %}
                            <script{% if csp_nonce %} nonce="{{ csp_nonce() }}" {% endif %}>
                                document.getElementById("unlink-eq-ci-{{ j }}").addEventListener('click', function () {
                                this.parentNode.submit()
                            });</script>
                    {% endfor %}
                {% endif %}
            {% endif %}

            {% if not locked %}
                {% if surveyEditPermission %}
                    <div class="ons-u-mb-m">
                        {% if eq_ci_selectors %}
                            {% set checkboxesData = {
                                "name": "checkbox-answer",
                                "legend": "eQ collection instruments available:"
                            } %}
        
                            {% set checkboxData = [] %}
        
                            <form id="form-select-eq-ci" action="" class="form" method="post" enctype="multipart/form-data">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                                <div id="ciSelectErrorPanel"
                                    class="{{'ons-panel ons-panel--simple ons-panel--error' if error.section == 'ciSelect' else ''}}">
                                    <div id="ciSelectErrorPanelBody" class="{{'ons-panel__body' if error.section == 'ciSelect' else ''}}">
                                        <input type="hidden" name="ce_id" value="{{ ce.id }}" />
                                        {% for ci in eq_ci_selectors %}
                                            {% do checkboxData.append(
                                                {
                                                    "id": ci.id,
                                                    "name": "checkbox-answer",
                                                    "label": {
                                                        "text": survey.surveyRef + ' ' + ci.file_name|string + ' eQ'
                                                    },
                                                    "value": ci.id
                                                }
                                            ) %}
                                        {% endfor %}
                                        {% do checkboxesData | setAttribute("checkboxes", checkboxData) %}
                                        {{ onsCheckboxes(checkboxesData) }}
                                        <div class="ons-u-mt-xxs">
                                            {{
                                                onsButton({
                                                    "text": "Add",
                                                    "id": "btn-add-ci",
                                                    "name": "select-eq-ci",
                                                    "classes": "ons-u-mt-s",
                                                    "variants": ['secondary', 'small']
                                                })
                                            }}
                                        </div>
                                    </div>
                                </div>
                            </form>
                        {% else %}
                            <div>
                                {% if not collection_instruments %}
                                    <p>This survey type is an EQ but no collection instruments have been set up for it yet.</p>
                                {% endif %}
                                <p><a href="{{ url_for('surveys_bp.get_link_collection_instrument', short_name=survey.shortName) }}" class="ons-btn ons-btn--secondary ons-btn--small"><span class="ons-btn__inner">Link collection instruments</span></a></p>
                            </div>
                        {% endif %}
                    </div>
                {% else %}
                    <div class="ons-u-mb-m">
                        {% if eq_ci_selectors %}
                            {% set surveyTableData = {
                                "variants": 'compact',
                                "id": "collection-instruments-table",
                                "caption": 'eQ collection instruments available:'
                            } %}
                            {% set surveyTableDataRows = [] %}
                            {% for ci in eq_ci_selectors %}
                                {% do surveyTableDataRows.append(
                                    {
                                        "tds": [
                                            {
                                                "value": survey.surveyRef + ' ' + ci.file_name|string + ' eQ'
                                            }
                                        ]
                                    }
                                ) %}
                            {% endfor %}
                            {% do surveyTableData | setAttribute("trs", surveyTableDataRows) %}
                            {{ onsTable(surveyTableData) }}
                        {% elif not(eq_ci_selectors or collection_instruments) %}
                            <div>
                                <p>This survey type is an EQ but no collection instruments have been set up for it yet.</p>
                            </div>
                        {% endif %}
                    </div>
                {% endif %}
            {% endif %}
        {% endif %}
</section>
