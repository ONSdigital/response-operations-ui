{% from "components/checkboxes/_checkbox-macro.njk" import onsCheckbox %}
<section class="ce-section {{'ons-panel ons-panel--simple ons-panel--error' if missing_ci else ''}} ons-u-pt-m ons-u-mb-l ons-u-mt-M">
    {% set surveyEditPermission = hasPermission('surveys.edit') %}
    {% if surveyEditPermission %}
        {% set linkText = 'Upload SEFT files' %}
    {% else %}
        {% set linkText = 'View SEFT files' %}
    {% endif %}
        {% if survey.surveyMode == 'SEFT' %}
            {{
                onsTable({
                    "variants": ['compact', 'responsive'],
                    "id": "collection-instruments-table",
                    "caption": 'Collection instruments',
                    "hideCaption": true,
                    "ths": [
                        { 
                            "value": "Collection instruments library",
                            "thClasses": "ons-u-fs-r--b"
                        },
                        {
                            "value": "Selected files",
                            "thClasses": "ons-u-fs-r--b"
                        },
                        {
                            "value": " ",
                            "thClasses": "ons-u-ta"
                        }
                    ],
                    "trs": [
                        {
                            "tds": [
                                {
                                    "value": "SEFT collection instruments",
                                    "tdClasses": "ons-u-ta"
                                },
                                {
                                    "value": collection_instruments|length|string,
                                    "name": "total-instruments",
                                    "tdClasses": "ons-u-ta"
                                },
                                {
                                    "value": '<a id="seft-upload-link" href="' + url_for('collection_exercise_bp.get_seft_collection_instrument', period=ce.exerciseRef, short_name=survey.shortName.replace(' ', '')) + '">' + linkText + '</a>',
                                    "name": "upload-seft-instruments",
                                    "tdClasses": "ons-u-ta-right"
                                }
                            ]
                        }
                    ]
                })
            }}
        {% endif %}
      
      
        {% if survey.surveyMode != 'SEFT' %}
            {% if collection_instruments %}
                {% set surveyTableDataHeader = [] %}
                {% set ths = 
                    [ 
                        {
                            "value": "Collection instruments (" + collection_instruments|length|string + ")",
                            "thClasses": "ons-u-fs-r--b"
                        },
                    ]
                %}  
                {% if surveyEditPermission %} 
                    {% do ths.append(
                        {
                            "value": " ",
                            "class": "ons-u-vh"
                        },
                    ) %} 
                {% endif %}
                {% set surveyTableData = {
                    "variants": ['compact', 'responsive'],
                    "id": "collection-instruments-table",
                    "caption": 'Collection instruments for this exercise',
                    "hideCaption": true,
                    "ths": ths
                } %}
                {% set surveyTableDataRows = [] %}
                {% for collection_instrument in collection_instruments %}
                    {% if not locked and surveyEditPermission%}
                        {% set formData =
                            '<form id="form-unselect-ci-' + loop.index|string + '" action="" method="post">' +
                            '<a href=# id="unlink-ci-' + loop.index|string + '"><svg class="ons-ons-svg-icon" viewBox="0 0 45 22" xmlns="http://www.w3.org/2000/svg" focusable="false"><path d="M0 0h24v24H0z" fill="none"/><path d="M7 11v2h10v-2H7zm5-9C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/></svg></a>' +
                            '<input type="hidden" name="ce_id" value="' + ce.id + '"/>' +
                            '<input type="hidden" name="ci_id" value="' + collection_instrument.id + '"/>' +
                            '<input type="hidden" name="unselect-ci"/>' +
                            '<input type="hidden" name="csrf_token" value="' + csrf_token() + '" />' +
                            '</form>'
                        %}
                    {% endif %}
                    {% set tds = 
                        [ 
                            {
                                "value": collection_instrument.file_name
                            },
                        ]
                    %}  
                    {% if surveyEditPermission %} 
                        {% do tds.append(
                            {
                                "value": formData,
                                "tdClasses": "ons-u-vh-right"
                            },
                        ) %} 
                    {% endif %}   
                    {% do surveyTableDataRows.append( 
                        { 
                            "tds": tds 
                        } 
                    )%}
  
                {% endfor %}
                {% do surveyTableData | setAttribute("trs", surveyTableDataRows) %}
                {{ onsTable(surveyTableData) }}
                {% if not locked %}
                    {% for i in range(surveyTableDataRows | length) %}
                        {% set j = i + 1 %}
                            <script{% if csp_nonce %} nonce="{{ csp_nonce() }}" {% endif %}>
                                document.getElementById("unlink-ci-{{ j }}").addEventListener('click', function () {
                                this.parentNode.submit()
                            });</script>
                    {% endfor %}
                {% endif %}
            {% endif %}
    
            {% if not locked %}
                {% if surveyEditPermission %}
                    <div class="ons-u-mb-m">
                         {%- call onsFieldset({
                            "legend": "Link collection instruments",
                            "legendClasses": "ons-u-vh" })
                        -%}
                            {{
                                onsInput({
                                    "id": "formtype",
                                    "name": "formtype",
                                    "type": "text",
                                    "maxLength": 4,
                                    "value": form.formtype.data,
                                    "classes": "input--w-5",
                                    "attributes": {
                                        "required": true
                                    },
                                    "label": {
                                        "text": 'Add form type',
                                        "description": "For example: 0101"
                                    }
                                })
                            }}
                        {% endcall %}
                        {{
                            onsButton({
                                "classes": "ons-u-mb-l ons-u-mt-s",
                                "variants": ['secondary', 'small'],
                                "text": "Upload",
                                "id": "save-btn"
                            })
                        }}
                    </div>
                    <form id="form-select-ci" class="form" method="post" role="form" action="">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                        {{
                            onsLabel({
                                "text": "Select EQ collection instruments"
                            })
                        }}
                        <div id="ciSelectErrorPanel"
                            class="{{'ons-panel ons-panel--simple ons-panel--error' if error.section == 'ciSelect' else ''}}">
                            <div id="ciSelectErrorPanelBody" class="{{'ons-panel__body' if error.section == 'ciSelect' else ''}}">
                                <button type="submit" class="ons-btn ons-u-mb-s ons-js-auto-selector ons-btn--small ons-btn--secondary" data-unselect-all="Unselect all" data-select-all="Select all">
                                  <span class="ons-btn__inner">
                                    <span class="ons-btn__text">
                                      <span class="ons-js-button-text">Select all</span>
                                  </span>
                                </button>
                                <input type="hidden" name="ce_id" value="{{ ce.id }}" />
                                  <table id="tbl-users" class="ons-table ons-table--responsive">
                                    <thead class="ons-table__head">
                                    <tr></tr>
                                    </thead>
                                    <tbody class="ons-table__body">
                                        {% for ci_split in eq_ci_selectors|batch(3) %}
                                          <tr class="ons-table__row">
                                            {% for ci in ci_split %}
                                                <td class="ons-table__cell" style="width: 33%; border-right: 10px solid white;">
                                                  {{
                                                      onsCheckbox({
                                                          "id": ci.id,
                                                          "classes": "ons-checkbox--no-border",
                                                          "name": "checkbox-answer",
                                                          "hideLabel": false,
                                                          "label": {
                                                              "text": ci.file_name|string
                                                          },
                                                          "value": ci.id
                                                      })
                                                  }}
                                                </td>
                                            {% endfor %}
                                          </tr>
                                        {% endfor %}
                                    </tbody>
                                  </table>
                                <div class="ons-u-mt-xxs">
                                    {{
                                        onsButton({
                                            "text": "Done",
                                            "id": "btn-add-ci",
                                            "name": "select-ci",
                                            "classes": "ons-u-mb-l ons-u-mt-s",
                                            "variants": 'small'
                                        })
                                    }}
                                </div>
                            </div>
                        </div>
                    </form>
                {% endif %}
            {% endif %}
        {% endif %}
</section>
